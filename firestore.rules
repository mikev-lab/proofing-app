rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. Helper Functions ---
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function userExists(userId) {
      return exists(/databases/$(database)/documents/users/$(userId));
    }

    function getProject(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data;
    }

    function isCompanyMember(companyId) {
      return request.auth != null &&
        userExists(request.auth.uid) &&
        getUserData(request.auth.uid).companyId == companyId;
    }

    // --- FIXED Guest Helper Function ---
    // Uses .get() for robust safety checking of custom claims.
    // This prevents runtime errors if the engine misinterprets the claim types.
    function hasValidGuestDataAccess(projectId, permission) {
       return request.auth != null &&
          // Check if guestProjectId exists and matches
          request.auth.token.get('guestProjectId', '') == projectId &&
          (
            // If we just need basic access (permission is empty string), allow it
            permission == '' || 
            // Otherwise, safely check the nested permissions map
            request.auth.token.get('guestPermissions', {}).get(permission, false) == true
          );
    }

    // --- 2. Users Collection ---
    match /users/{userId} {
      // Allow User to create own, Admin to create any, OR Company Admin creating staff
      allow create: if request.auth.uid == userId || 
        isAdmin() || 
        (
          request.auth != null &&
          userExists(request.auth.uid) &&
          getUserData(request.auth.uid).companyRole == 'admin' &&
          request.resource.data.companyId == getUserData(request.auth.uid).companyId &&
          request.resource.data.role == 'client_user'
        );

      allow read, update: if request.auth.uid == userId || isAdmin();
      allow delete: if isAdmin();
    }

    // --- 3. Companies Collection ---
    match /companies/{companyId} {
      // Allow owner to create
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;
      
      allow read: if isCompanyMember(companyId) || isAdmin();
      
      // Allow Owner/Company Admin to update
      allow update: if isAdmin() || (
        request.auth != null && (
          request.auth.uid == resource.data.ownerUid ||
          (isCompanyMember(companyId) && getUserData(request.auth.uid).companyRole == 'admin')
        )
      );
      
      allow delete: if isAdmin();
    }

    // --- 4. Projects Collection ---
    match /projects/{projectId} {
      // Admin Override
      allow read, write: if isAdmin();
      
      // --- Locks Sub-collection ---
      match /locks/{lockId} {
         // Allow ANY valid guest (even viewers) to SEE if the project is locked
         allow read: if 
           isAdmin() ||
           hasValidGuestDataAccess(projectId, '') || 
           (request.auth != null && userExists(request.auth.uid) && getUserData(request.auth.uid).companyId == getProject(projectId).companyId);

         // Only allow Editors (canUpload/isOwner) to actually LOCK/UNLOCK
         allow write: if 
           isAdmin() ||
           hasValidGuestDataAccess(projectId, 'canUpload') || 
           hasValidGuestDataAccess(projectId, 'isOwner') || 
           (request.auth != null && userExists(request.auth.uid) && getUserData(request.auth.uid).companyId == getProject(projectId).companyId);
      }

      // GET (Single Doc) - Keep '' here (View access is fine for any valid guest)
      allow get: if 
         isAdmin() ||
         hasValidGuestDataAccess(projectId, '') || 
         (
           request.auth != null &&
           userExists(request.auth.uid) &&
           (
             getUserData(request.auth.uid).companyId == resource.data.companyId ||
             request.auth.uid == resource.data.clientId 
           )
         );

      // LIST
      allow list: if request.auth != null;

      // UPDATE
      allow update: if 
         isAdmin() ||
         // A. Guest Logic (Uploads, Saves, Status)
         (
           // FIX: Restored 'canUpload' check. 
           // Now, read-only guests CANNOT change specs or builder state.
           (hasValidGuestDataAccess(projectId, 'canUpload') || hasValidGuestDataAccess(projectId, 'isOwner')) &&
           request.resource.data.diff(resource.data).affectedKeys().hasAny([
             'status', 'lastUploadAt', 'specs', 'guestBuilderState', 
             'projectType', 'editorLock', 'guestUploadStatus', 'guestBuildData'
           ])
         )
         ||
         // B. Guest Logic (Approvals only)
         (
           (hasValidGuestDataAccess(projectId, 'canApprove') || hasValidGuestDataAccess(projectId, 'isOwner')) &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
         )
         ||
         // C. Client Logic (Status Change OR File Upload Handshake)
         (
            request.auth != null &&
            userExists(request.auth.uid) &&
            getUserData(request.auth.uid).companyId == resource.data.companyId &&
            (
              // Simple status update
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])) ||
              // Complex Client Upload Handshake
              (
                resource.data.isAwaitingClientUpload == true &&
                request.resource.data.isAwaitingClientUpload == false &&
                request.resource.data.status == 'pending' &&
                request.resource.data.versions.size() == resource.data.versions.size() + 1
              )
            )
         );

      // --- Sub-collections ---
      match /guestLinks/{linkId} {
          allow read, write: if isAdmin();
          allow get: if true;
          allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewHistory']);
      }
      
      match /pages/{pageId} {
          allow read, write: if isAdmin() || (request.auth != null && isCompanyMember(getProject(projectId).companyId));
      }

      match /history/{historyId} {
        allow read: if isAdmin() || isCompanyMember(getProject(projectId).companyId) || hasValidGuestDataAccess(projectId, '');
        allow create, update, delete: if false;
      }
      
      match /annotations/{annotationId} {
        // Admin
        allow read, write: if isAdmin();
        
        // Client Access
        allow read, create: if request.auth != null && userExists(request.auth.uid) && (
            getUserData(request.auth.uid).companyId == getProject(projectId).companyId ||
            request.auth.uid == getProject(projectId).clientId
        );

        // Author Access
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorUid;

        // Guest Access - specific permissions required
        allow read: if hasValidGuestDataAccess(projectId, 'canSeeComments') || hasValidGuestDataAccess(projectId, 'isOwner');
        allow create: if hasValidGuestDataAccess(projectId, 'canAnnotate') || hasValidGuestDataAccess(projectId, 'isOwner');
      }
    }

    // --- 5. Settings / Estimators ---
    match /settings/globalEstimatorDefaults {
      allow read: if request.auth != null; 
      allow write: if isAdmin();
    }

    match /settings/{document=**} { 
      allow read, write: if isAdmin(); 
    }

    match /impositionDefaults/{ruleId} { 
      allow read, write: if isAdmin(); 
    }

    // --- 6. Other Collections ---
    match /temp_processing/{docId} {
      allow read, write: if request.auth != null && (
         docId == request.auth.uid || 
         docId.matches(request.auth.uid + '_.*')
      );
    }
    
    match /notifications/{notificationId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.recipientUid;
    }
    
    match /admin_notifications/{notificationId} { allow read, write: if isAdmin(); }
    match /vendors/{vendorId} { allow read, write: if isAdmin(); }
    match /inventory/{stockId} { allow read, write: if isAdmin(); }
    match /inventoryPurchases/{purchaseId} { allow read, create: if isAdmin(); allow update, delete: if false; }

  }
}