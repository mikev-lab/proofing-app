<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCE Shop Floor Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Idle State -->
    <div id="idle-screen" class="text-center">
        <h1 class="text-6xl font-bold text-white mb-8 tracking-tighter">Scan Job Ticket</h1>
        <div class="animate-pulse mb-8">
            <svg class="h-48 w-48 text-gray-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4v1m6 11h2m-6 0h-2v4h-4v-4H6v-4h6v4m0-10a4 4 0 110 8 4 4 0 010-8z" />
            </svg>
        </div>
        <!-- Hidden Input for Scanner -->
        <input type="text" id="scan-input" class="opacity-0 absolute top-0 left-0 w-full h-full cursor-none" autofocus autocomplete="off">
        <p class="text-gray-500 text-xl">Ready for scanner input...</p>
    </div>

    <!-- Processing State -->
    <div id="processing-screen" class="hidden text-center">
        <div class="h-24 w-24 animate-spin rounded-full border-8 border-t-indigo-500 border-gray-800 mx-auto mb-8"></div>
        <h2 class="text-4xl font-bold text-white">Looking up Job...</h2>
    </div>

    <!-- Action State (Found Job) -->
    <div id="action-screen" class="hidden w-full max-w-4xl bg-slate-900 border-2 border-slate-700 rounded-xl p-8 shadow-2xl">
        <div class="flex justify-between items-start mb-8 border-b border-slate-700 pb-4">
            <div>
                <p class="text-gray-400 uppercase font-bold text-sm tracking-widest">Current Job</p>
                <h1 class="text-5xl font-bold text-white leading-tight" id="job-name">Project Name</h1>
            </div>
            <div class="text-right">
                <span id="current-stage-badge" class="px-4 py-2 rounded text-xl font-bold bg-blue-600 text-white">Printing</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <button class="action-btn h-32 bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 rounded-lg flex flex-col items-center justify-center transition-all" data-action="Printing">
                <span class="text-3xl">üñ®Ô∏è</span>
                <span class="text-xl font-bold text-white mt-2">Printing</span>
            </button>
            <button class="action-btn h-32 bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 rounded-lg flex flex-col items-center justify-center transition-all" data-action="Finishing">
                <span class="text-3xl">‚úÇÔ∏è</span>
                <span class="text-xl font-bold text-white mt-2">Finishing</span>
            </button>
            <button class="action-btn h-32 bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 rounded-lg flex flex-col items-center justify-center transition-all" data-action="Complete">
                <span class="text-3xl">üì¶</span>
                <span class="text-xl font-bold text-white mt-2">Complete</span>
            </button>
            <button id="cancel-btn" class="h-32 bg-red-900/30 hover:bg-red-900/50 border-2 border-red-800 rounded-lg flex flex-col items-center justify-center transition-all">
                <span class="text-3xl">‚ùå</span>
                <span class="text-xl font-bold text-red-200 mt-2">Cancel / Reset</span>
            </button>
        </div>

        <p class="text-center text-gray-500">Tap a stage to move the job.</p>
    </div>

    <!-- Success Feedback -->
    <div id="success-overlay" class="hidden fixed inset-0 bg-green-600 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="bg-white rounded-full p-4 inline-block mb-4">
                <svg class="h-24 w-24 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h1 class="text-6xl font-bold text-white">UPDATED</h1>
        </div>
    </div>

    <script type="module">
        import { db, functions } from './js/firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const scanInput = document.getElementById('scan-input');
        const idleScreen = document.getElementById('idle-screen');
        const processingScreen = document.getElementById('processing-screen');
        const actionScreen = document.getElementById('action-screen');
        const successOverlay = document.getElementById('success-overlay');
        const jobNameEl = document.getElementById('job-name');
        const currentStageEl = document.getElementById('current-stage-badge');

        let currentProjectId = null;

        // --- NEW: Kiosk Helper Cloud Function ---
        const updateKioskStatus = httpsCallable(functions, 'kiosk_updateStatus');

        // Auto-focus logic for scanner
        document.addEventListener('click', () => {
            if (!actionScreen.classList.contains('hidden')) return;
            scanInput.focus();
        });
        scanInput.focus();

        scanInput.addEventListener('change', async (e) => {
            const projectId = e.target.value.trim();
            if (!projectId) return;

            scanInput.value = ''; // Clear for next scan
            await loadJob(projectId);
        });

        async function loadJob(id) {
            currentProjectId = id;
            idleScreen.classList.add('hidden');
            processingScreen.classList.remove('hidden');

            try {
                const snap = await getDoc(doc(db, "projects", id));
                if (!snap.exists()) {
                    alert("Job Ticket Not Found!");
                    resetKiosk();
                    return;
                }
                const data = snap.data();
                jobNameEl.textContent = data.projectName;
                currentStageEl.textContent = data.productionStatus || 'Unknown';

                processingScreen.classList.add('hidden');
                actionScreen.classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("Error loading job.");
                resetKiosk();
            }
        }

        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const newStatus = btn.dataset.action;
                if (!currentProjectId) return;

                // Optimistic UI
                actionScreen.classList.add('hidden');
                successOverlay.classList.remove('hidden');

                try {
                    // --- NEW: Call Cloud Function instead of direct Firestore update ---
                    await updateKioskStatus({
                        projectId: currentProjectId,
                        newStatus: newStatus
                    });

                    setTimeout(() => {
                        successOverlay.classList.add('hidden');
                        resetKiosk();
                    }, 1500);
                } catch(e) {
                    console.error(e);
                    alert("Failed to update status: " + e.message);
                    resetKiosk();
                }
            });
        });

        document.getElementById('cancel-btn').addEventListener('click', resetKiosk);

        function resetKiosk() {
            currentProjectId = null;
            successOverlay.classList.add('hidden');
            actionScreen.classList.add('hidden');
            processingScreen.classList.add('hidden');
            idleScreen.classList.remove('hidden');
            scanInput.value = '';
            scanInput.focus();
        }
    </script>
</body>
</html>
