<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCE Printing - Proof Details</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #pdf-viewer {
            position: relative; /* Needed for absolute positioning of nav controls */
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent canvas overflow */
            cursor: default; /* Base cursor */
        }
        #pdf-canvas {
            /* Canvas itself takes full space, drawing is clipped */
             display: block; /* Remove extra space below canvas */
        }
        #navigation-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: rgba(15, 23, 42, 0.8); /* bg-slate-900/80 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            backdrop-filter: blur(4px);
            z-index: 10; /* Ensure controls are on top */
        }
        /* Style for grab/grabbing cursor */
        #pdf-viewer.grabbable { cursor: grab; }
        #pdf-viewer.grabbing { cursor: grabbing; }
    </style>

    <!-- PDF.js Library -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>

</head>
<body class="min-h-screen bg-gradient-to-br from-[#0f172a] to-[#334155] text-gray-100">

    <!-- Header Navigation -->
    <nav class="bg-slate-800/60 backdrop-blur-sm shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Title -->
                <div class="flex-shrink-0 flex items-center">
                    <!-- Updated with MCE Printing -->
                    <h1 class="text-2xl font-bold text-white">MCE Printing</h1>
                </div>

                <!-- User Info & Logout -->
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-sm font-semibold text-white hover:text-gray-200">Dashboard</a>
                    <a href="account.html" class="text-sm font-semibold text-white hover:text-gray-200">My Account</a>
                    <div class="relative">
                        <button id="notification-bell" class="relative text-gray-400 hover:text-white">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                            </svg>
                            <span id="notification-indicator" class="hidden absolute -top-0.5 -right-0.5 h-2 w-2 rounded-full bg-red-500"></span>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-slate-800 rounded-lg shadow-lg border border-slate-700/50 z-10">
                            <div class="p-3 border-b border-slate-700/50">
                                <h3 class="font-semibold text-white">Notifications</h3>
                            </div>
                            <div id="notification-list" class="py-1 max-h-96 overflow-y-auto">
                                <p class="px-4 py-2 text-sm text-gray-400">No new notifications</p>
                            </div>
                        </div>
                    </div>
                    <span id="user-email" class="text-sm text-gray-300 hidden sm:block">Welcome...</span>
                    <button id="logout-button" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md text-sm transition-all duration-150 ease-in-out">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main>
        <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center py-12">
                <div class="h-12 w-12 animate-spin rounded-full border-4 border-t-indigo-400 border-indigo-900 mx-auto" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-4 text-gray-300">Fetching your proof...</p>
            </div>

            <!-- Proof content will be loaded here -->
            <div id="proof-content" class="hidden">
                <!-- Header: Project Name & Back Button -->
                <div class="flex justify-between items-center mb-8">
                    <a href="dashboard.html" class="text-indigo-400 hover:text-indigo-300 transition-colors">&larr; Back to Dashboard</a>
                    <h2 id="project-name" class="text-3xl font-bold text-white text-right">Project Name</h2>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <!-- Far Left Column: Thumbnails -->
                    <div class="lg:col-span-1 bg-slate-900/50 rounded-lg shadow-2xl p-4 min-h-[600px] max-h-[80vh] overflow-y-auto">
                        <h3 class="text-xl font-semibold text-white mb-4 sticky top-0 bg-slate-900/50 backdrop-blur-sm z-10 py-2">Pages</h3>
                        <div id="thumbnail-list" class="space-y-4">
                            <!-- Thumbnail items will be injected here by JavaScript -->
                        </div>
                    </div>
                    <!-- Center Column: Proof Viewer -->
                    <div class="lg:col-span-2 bg-slate-900/50 rounded-lg shadow-2xl min-h-[600px] flex flex-col p-4 max-h-[80vh]">
                        <!-- Container for viewer controls -->
                        <div id="pdf-viewer" class="flex-1 bg-black/20 rounded-md flex justify-center items-center relative">
                            <canvas id="pdf-canvas"></canvas>
                            <!-- Rendering Throbber -->
                            <div id="rendering-throbber" class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-sm flex flex-col items-center justify-center z-20">
                                <div class="h-10 w-10 animate-spin rounded-full border-4 border-t-indigo-400 border-indigo-900" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-3 text-gray-300 text-sm">Rendering PDF...</p>
                            </div>
                            <div id="navigation-controls" class="hidden">
                                 <!-- Page Navigation -->
                                <button id="prev-page" class="text-white px-2 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50" title="Previous Page">&lt;</button>
                                <span class="text-white px-2" id="page-num"></span> / <span class="text-white px-2" id="page-count"></span>
                                <button id="next-page" class="text-white px-2 py-1 rounded-md hover:bg-slate-700 disabled:opacity-50" title="Next Page">&gt;</button>

                                <!-- Tool Selector -->
                                <div id="tool-selector" class="ml-4 flex items-center border-l border-slate-600 pl-4 space-x-1">
                                    <button id="tool-pan" title="Pan Tool" class="text-white p-2 rounded-md hover:bg-slate-700 bg-slate-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 11.5a2.5 2.5 0 0 1 5 0Z"/><path d="M4 5.5a2.5 2.5 0 0 1 5 0Z"/><path d="M12 5.5a2.5 2.5 0 0 1 5 0Z"/><path d="M15 11.5a2.5 2.5 0 0 1 5 0Z"/><path d="M5 17.5a2.5 2.5 0 0 1 5 0Z"/><path d="m17 22 5-5"/><path d="m2 7 5 5"/></svg>
                                    </button>
                                    <button id="tool-comment" title="Comment Tool" class="text-white p-2 rounded-md hover:bg-slate-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
                                    </button>
                                </div>

                                <!-- Zoom Controls -->
                                <div class="ml-4 flex items-center border-l border-slate-600 pl-4">
                                    <button id="zoom-out-button" title="Zoom Out" class="text-white px-2 py-1 rounded-md text-lg hover:bg-slate-700 disabled:opacity-50">-</button>
                                    <button id="zoom-reset-button" title="Reset Zoom & Pan" class="text-white px-2 py-1 rounded-md text-sm hover:bg-slate-700 disabled:opacity-50">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                                    </button>
                                    <button id="zoom-in-button" title="Zoom In" class="text-white px-2 py-1 rounded-md text-lg hover:bg-slate-700 disabled:opacity-50">+</button>
                                    <span id="zoom-level-display" class="text-xs text-gray-300 w-12 text-center">100%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Actions, Guides & Comments -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-slate-800/60 backdrop-blur-sm shadow-xl rounded-xl p-6 border border-slate-700/50">
                            <h3 class="text-xl font-semibold text-white mb-4">Actions</h3>
                            <form id="approval-form">
                                <div id="decision-buttons">
                                    <button type="button" id="approve-button" class="w-full text-center rounded-lg bg-green-600 px-4 py-3 text-sm font-semibold leading-6 text-white shadow-md hover:bg-green-500 transition-all duration-150 ease-in-out">
                                        Approve
                                    </button>
                                    <button type="button" id="request-changes-button" class="mt-3 w-full text-center rounded-lg bg-red-600 px-4 py-3 text-sm font-semibold leading-6 text-white shadow-md hover:bg-red-500 transition-all duration-150 ease-in-out">
                                        Request Changes
                                    </button>
                                </div>
                                <div id="confirmation-section" class="hidden mt-4">
                                     <p id="confirmation-message" class="text-center text-gray-300 mb-4"></p>
                                     <button type="submit" id="confirm-action-button" class="w-full text-center rounded-lg px-4 py-3 text-sm font-semibold text-white shadow-md transition-all duration-150 ease-in-out">
                                         Confirm
                                     </button>
                                     <button type="button" id="cancel-action-button" class="mt-3 w-full text-center rounded-lg bg-gray-600 px-4 py-3 text-sm font-semibold text-white shadow-md hover:bg-gray-500 transition-all duration-150 ease-in-out">
                                         Cancel
                                     </button>
                                </div>
                            </form>
                        </div>
                        <div id="guides-section" class="bg-slate-800/60 backdrop-blur-sm shadow-xl rounded-xl p-6 border border-slate-700/50 hidden">
                            <h3 class="text-xl font-semibold text-white mb-4">Guides</h3>
                            <div class="mb-4">
                                <label for="view-mode-select" class="block text-sm font-medium text-gray-300">View Mode</label>
                                <select id="view-mode-select" name="view-mode-select" class="mt-1 block w-full rounded-lg border-0 bg-white/5 py-2 px-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6">
                                    <option value="single">Single Page</option>
                                    <option value="spread">Spread (Book)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="show-trim-guide" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 bg-white/10 cursor-pointer">
                                    <label for="show-trim-guide" class="ml-2 block text-sm text-gray-300 cursor-pointer">Show Trim (Black)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="show-bleed-guide" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 bg-white/10 cursor-pointer">
                                    <label for="show-bleed-guide" class="ml-2 block text-sm text-gray-300 cursor-pointer">Show Bleed (Red)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="show-safety-guide" checked class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 bg-white/10 cursor-pointer">
                                    <label for="show-safety-guide" class="ml-2 block text-sm text-gray-300 cursor-pointer">Show Safety (Green)</label>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800/60 backdrop-blur-sm shadow-xl rounded-xl p-6 border border-slate-700/50">
                            <h3 class="text-xl font-semibold text-white mb-4">Comments</h3>
                            <div id="comments-section" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                                <p class="text-gray-400">No comments yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeSharedViewer } from './js/viewer.js';
        import { getFirestore, doc, onSnapshot, updateDoc, collection, getDocs, Timestamp, addDoc, getDoc, arrayUnion, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import * as pdfjsLib from "https://mozilla.github.io/pdf.js/build/pdf.mjs";

        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://mozilla.github.io/pdf.js/build/pdf.worker.mjs";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyApmEJdFi96QS3TwYh7GyEDSbZrCuVpBrg",
            authDomain: "proofing-application.firebaseapp.com",
            projectId: "proofing-application",
            storageBucket: "proofing-application.firebasestorage.app",
            messagingSenderId: "452256252711",
            appId: "1:452256252711:web:68795c1e5cc9438ff05f02",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- PARSE URL PARAMS ONCE AT SCRIPT LOAD ---
        const urlParams = new URLSearchParams(window.location.search);
        const initialGuestToken = urlParams.get('guestToken');
        // *** FIX: The URL parameter is 'projectId', not 'id' ***
        const initialProjectId = urlParams.get('projectId'); // <<< Was urlParams.get('id')
        console.log(`[Init] Parsed URL Params - Guest Token: ${initialGuestToken}, Project ID: ${initialProjectId}`);
        // --- END PARSE URL PARAMS ---


        const userEmailSpan = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const proofContent = document.getElementById('proof-content');
        const projectName = document.getElementById('project-name');
        // const approvalForm = document.getElementById('approval-form'); // Defined later, inside onSnapshot
        const decisionButtons = document.getElementById('decision-buttons');
        const confirmationSection = document.getElementById('confirmation-section');


        let currentProjectId = initialProjectId; // Use the initially parsed ID
        let actionToConfirm = null;
        let unsubscribeProjectListener = null;
        let isGuest = false;
        let guestPermissions = {};

        // Define these functions in the main script scope
        function showApproveConfirmation() {
            showConfirmation('approve');
        }
        function showRequestChangesConfirmation() {
            showConfirmation('request-changes');
        }


        // --- Guest Authentication Flow ---
        async function handleGuestAccess(projectId, guestToken) {
            console.log(`[Guest Flow] Starting for projectId: ${projectId}, token: ${guestToken}`);
            try {
                // 1. Fetch Guest Link Details
                console.log('[Guest Flow] Attempting to read guest link document...');
                const linkRef = doc(db, "projects", projectId, "guestLinks", guestToken);
                const linkSnap = await getDoc(linkRef);
                console.log('[Guest Flow] Guest link document read attempt complete.');

                if (!linkSnap.exists()) {
                    console.error("[Guest Flow] Guest link document does not exist.");
                    throw new Error("This share link is invalid.");
                }

                const linkData = linkSnap.data();
                console.log('[Guest Flow] Guest link data:', linkData);
                const now = Timestamp.now();
                if (linkData.expiresAt.seconds < now.seconds) {
                    console.error("[Guest Flow] Guest link has expired.");
                    throw new Error("This share link has expired.");
                }

                isGuest = true; // Set isGuest flag HERE after validation succeeds
                guestPermissions = linkData.permissions;
                console.log('[Guest Flow] Set guest permissions:', guestPermissions);

                // 2. Sign In Anonymously (Ensure we only do this if not already anon)
                let userCredential;
                if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                    console.log('[Guest Flow] Attempting anonymous sign-in...');
                    userCredential = await signInAnonymously(auth);
                    const guestUid = userCredential.user.uid;
                    console.log('[Guest Flow] Anonymous sign-in successful, UID:', guestUid);
                } else {
                    userCredential = { user: auth.currentUser }; // Use existing anon user
                    console.log('[Guest Flow] Using existing anonymous user, UID:', userCredential.user.uid);
                }


                // 3. Create a 'claim' to link anon UID to the token for security rules
                console.log('[Guest Flow] Attempting to create guest claim document...');
                const claimRef = doc(db, "guest_claims", userCredential.user.uid);
                // Ensure projectId passed here is the one from the function argument
                await setDoc(claimRef, { projectId: projectId, guestToken: guestToken });
                console.log('[Guest Flow] Guest claim document created successfully.');


                // 4. Log the view event
                console.log('[Guest Flow] Skipping view history update for debugging.');
                // updateDoc(linkRef, { ... }).catch(...)

                // 5. Hide unnecessary UI for guests
                console.log('[Guest Flow] Hiding guest UI elements...');
                document.querySelector('nav')?.classList.add('hidden');
                const backButton = document.querySelector('a[href="dashboard.html"]');
                if(backButton) backButton.classList.add('hidden');
                const accountButton = document.querySelector('a[href="account.html"]');
                if(accountButton) accountButton.classList.add('hidden');


                // 6. Proceed with loading the project
                console.log('[Guest Flow] Calling loadProjectForUser...');
                loadProjectForUser(userCredential.user); // Pass the anonymous user object

            } catch (error) {
                console.error("[Guest Flow] Detailed guest access error:", error);
                loadingSpinner.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        } // --- End handleGuestAccess ---


        // --- UI Helper Functions ---
        function showConfirmation(action) {
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionButton = document.getElementById('confirm-action-button');
            const localDecisionButtons = document.getElementById('decision-buttons');
            const localConfirmationSection = document.getElementById('confirmation-section');

            if (!confirmationMessage || !confirmActionButton || !localDecisionButtons || !localConfirmationSection) {
                 console.error("Confirmation UI elements not found.");
                 return;
            }

            actionToConfirm = action;
            confirmationMessage.textContent = action === 'approve'
                ? 'Are you sure you want to approve this proof?'
                : 'Are you sure you want to request changes for this proof?';
            confirmActionButton.textContent = action === 'approve' ? 'Confirm Approval' : 'Confirm Request';
            confirmActionButton.className = `w-full text-center rounded-lg px-4 py-3 text-sm font-semibold text-white shadow-md transition-all duration-150 ease-in-out ${action === 'approve' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}`;
            confirmActionButton.disabled = false;
            localDecisionButtons.classList.add('hidden');
            localConfirmationSection.classList.remove('hidden');
        }

        function hideConfirmation() {
             const localDecisionButtons = document.getElementById('decision-buttons');
             const localConfirmationSection = document.getElementById('confirmation-section');
             if (!localDecisionButtons || !localConfirmationSection) {
                 console.error("Confirmation UI elements not found.");
                 return;
             }
            actionToConfirm = null;
            localDecisionButtons.classList.remove('hidden');
            localConfirmationSection.classList.add('hidden');
        }

        async function updateProjectStatus(status) {
            console.log(`[Update Status] Attempting to update project ${currentProjectId} to ${status}`);
            const projectRef = doc(db, "projects", currentProjectId);
             const confirmActionButton = document.getElementById('confirm-action-button');

            try {
                 await updateDoc(projectRef, { status: status });
                 console.log(`[Update Status] Successfully updated project ${currentProjectId} to ${status}`);
                 if (!isGuest) {
                   window.location.href = 'dashboard.html';
                 } else {
                     const actionPanel = document.querySelector('#approval-form')?.parentElement;
                     if(actionPanel) {
                       actionPanel.innerHTML = `<p class="text-center text-lg font-semibold ${status === 'approved' ? 'text-green-400' : 'text-red-400'}">Status updated to ${status}.</p>`;
                     }
                     hideConfirmation();
                 }
            } catch (error) {
                console.error("[Update Status] Error updating status:", error);
                alert(`Failed to update status: ${error.message}`);
                 if (confirmActionButton) {
                    confirmActionButton.disabled = false;
                    confirmActionButton.textContent = actionToConfirm === 'approve' ? 'Confirm Approval' : 'Confirm Request';
                 }
                hideConfirmation();
            }
        }
        // --- End of UI Helper Functions ---


        // --- Project Data Loader ---
         function loadProjectForUser(user) {
            // Use currentProjectId (which should be set from initialProjectId)
            console.log(`[Load Project] Starting for user: ${user?.uid || 'anonymous/unknown'}, projectId: ${currentProjectId}, isGuest: ${isGuest}`);

            if (!currentProjectId) {
                console.error('[Load Project] No project ID available.');
                loadingSpinner.innerHTML = '<p class="text-red-400">Error: No project ID specified in URL.</p>';
                return;
            }

            if (user && !isGuest) {
                 userEmailSpan.textContent = user.email;
                 userEmailSpan.classList.remove('hidden');
                 if(logoutButton) logoutButton.classList.remove('hidden');
            } else if (isGuest && user) {
                 userEmailSpan.textContent = "Guest User";
                 userEmailSpan.classList.remove('hidden');
                 if(logoutButton) logoutButton.classList.add('hidden');
            } else {
                console.warn('[Load Project] loadProjectForUser called with null user.');
            }

            console.log(`[Load Project] Setting up Firestore listener for project: ${currentProjectId}`);
            const projectRef = doc(db, "projects", currentProjectId);

            if (unsubscribeProjectListener) {
                console.log('[Load Project] Unsubscribing previous listener.');
                unsubscribeProjectListener();
                unsubscribeProjectListener = null;
            }


            unsubscribeProjectListener = onSnapshot(projectRef, (docSnap) => {
                console.log(`[Load Project] onSnapshot triggered. docSnap exists: ${docSnap.exists()}`);
                if (docSnap.exists()) {
                    const projectData = docSnap.data();
                    console.log('[Load Project] Project data received:', projectData);

                    if(projectName) projectName.textContent = projectData.projectName;

                    const actionPanel = document.querySelector('#approval-form')?.parentElement;
                    const commentTool = document.getElementById('tool-comment');

                    if (actionPanel && commentTool) {
                        // Reset action panel HTML to original state
                        // This fixes the issue where buttons disappeared after a status change
                        actionPanel.innerHTML = `
                            <h3 class="text-xl font-semibold text-white mb-4">Actions</h3>
                            <form id="approval-form">
                                <div id="decision-buttons">
                                    <button type="button" id="approve-button" class="w-full text-center rounded-lg bg-green-600 px-4 py-3 text-sm font-semibold leading-6 text-white shadow-md hover:bg-green-500 transition-all duration-150 ease-in-out">
                                        Approve
                                    </button>
                                    <button type="button" id="request-changes-button" class="mt-3 w-full text-center rounded-lg bg-red-600 px-4 py-3 text-sm font-semibold leading-6 text-white shadow-md hover:bg-red-500 transition-all duration-150 ease-in-out">
                                        Request Changes
                                    </button>
                                </div>
                                <div id="confirmation-section" class="hidden mt-4">
                                     <p id="confirmation-message" class="text-center text-gray-300 mb-4"></p>
                                     <button type="submit" id="confirm-action-button" class="w-full text-center rounded-lg px-4 py-3 text-sm font-semibold text-white shadow-md transition-all duration-150 ease-in-out">
                                         Confirm
                                     </button>
                                     <button type="button" id="cancel-action-button" class="mt-3 w-full text-center rounded-lg bg-gray-600 px-4 py-3 text-sm font-semibold text-white shadow-md hover:bg-gray-500 transition-all duration-150 ease-in-out">
                                         Cancel
                                     </button>
                                </div>
                            </form>`;
                         
                         // Re-attach the main form submit listener after resetting HTML
                         const newApprovalForm = document.getElementById('approval-form');
                         if(newApprovalForm) {
                            newApprovalForm.addEventListener('submit', (e) => {
                                e.preventDefault();
                                console.log(`[Approval Form] Re-attached submit handler. Action: ${actionToConfirm}`);
                                const confirmBtn = document.getElementById('confirm-action-button');
                                if (actionToConfirm && confirmBtn) {
                                    confirmBtn.disabled = true;
                                    confirmBtn.textContent = 'Processing...';
                                    updateProjectStatus(actionToConfirm === 'approve' ? 'approved' : 'changes_requested');
                                } else {
                                     console.warn('[Approval Form] Re-attached submit handler called but no action selected or button not found.');
                                     hideConfirmation();
                                }
                            });
                         }

                        // Apply Guest Permissions
                        if (isGuest) {
                            actionPanel.style.display = guestPermissions.canApprove ? 'block' : 'none';
                            commentTool.style.display = guestPermissions.canAnnotate ? 'block' : 'none';
                            console.log(`[Load Project] Guest UI set: canApprove=${guestPermissions.canApprove}, canAnnotate=${guestPermissions.canAnnotate}`);
                        } else {
                            actionPanel.style.display = 'block';
                            commentTool.style.display = 'block';
                        }

                        // Check Project Status (AFTER resetting HTML)
                        if (projectData.status === 'approved' || projectData.status === 'changes_requested') {
                             actionPanel.innerHTML = `<p class="text-center text-lg font-semibold ${projectData.status === 'approved' ? 'text-green-400' : 'text-red-400'}">${projectData.status === 'approved' ? 'Proof Approved' : 'Changes Requested'}</p>`;
                             commentTool.style.display = 'none';
                             console.log(`[Load Project] Project status is ${projectData.status}, hiding action buttons and comment tool.`);
                         } else {
                             // Status is pending, add listeners to the (now existing) buttons
                             console.log(`[Load Project] Project status is ${projectData.status}, adding button listeners.`);
                             const approveButton = document.getElementById('approve-button');
                             const requestChangesButton = document.getElementById('request-changes-button');
                             const cancelActionButton = document.getElementById('cancel-action-button');

                             if (approveButton) approveButton.addEventListener('click', showApproveConfirmation);
                             if (requestChangesButton) requestChangesButton.addEventListener('click', showRequestChangesConfirmation);
                             if (cancelActionButton) cancelActionButton.addEventListener('click', hideConfirmation);
                         }

                    } else {
                        console.warn('[Load Project] Action panel or comment tool element not found.');
                    }


                    console.log('[Load Project] Initializing shared viewer...');
                    initializeSharedViewer({
                        db,
                        auth,
                        projectId: currentProjectId,
                        projectData: projectData,
                        isAdmin: false,
                        isGuest: isGuest,
                        guestPermissions: guestPermissions
                    });
                    console.log('[Load Project] Shared viewer initialization called.');


                    loadingSpinner.classList.add('hidden');
                    proofContent.classList.remove('hidden');
                } else {
                     console.error(`[Load Project] Project document ${currentProjectId} not found.`);
                    loadingSpinner.innerHTML = '<p class="text-red-400">Error: Project not found.</p>';
                }
            }, (error) => {
                console.error("[Load Project] Firestore listener error:", error);
                loadingSpinner.innerHTML = `<p class="text-red-400">Error loading project data: ${error.message}</p>`;
                 if (unsubscribeProjectListener) {
                     unsubscribeProjectListener();
                     unsubscribeProjectListener = null;
                 }
            });
             console.log('[Load Project] Firestore listener attached.');
        } // --- End loadProjectForUser ---


        // --- AUTHENTICATION STATE MANAGER ---
        let isProcessingGuestLink = false; // Flag to prevent multiple concurrent guest handling attempts

        onAuthStateChanged(auth, (user) => {
            // Use the constants initialGuestToken and initialProjectId parsed outside
            console.log(`[Auth State] Fired. User: ${user ? user.uid + (user.isAnonymous ? ' (anon)' : '') : 'null'}, Initial Guest Token: ${initialGuestToken}, Initial Project ID: ${initialProjectId}, isProcessing: ${isProcessingGuestLink}, isGuest: ${isGuest}`);

            // Clear previous listener if it exists and we are changing context
             if (unsubscribeProjectListener && (isProcessingGuestLink || (initialGuestToken && initialProjectId) || (user && !user.isAnonymous))) {
                 console.log('[Auth State] Unsubscribing existing project listener.');
                 unsubscribeProjectListener();
                 unsubscribeProjectListener = null;
             }
             // Reset guest status at the start unless we are already processing a guest link
             if (!isProcessingGuestLink) {
                isGuest = false;
                guestPermissions = {};
             }


            // --- PRIORITY 1: Handle Guest Link ---
            // We use the constants parsed at the top of the script
            if (initialGuestToken && initialProjectId) {
                console.log('[Auth State] Condition MET: Initial guestToken and projectId found.');
                if (!isProcessingGuestLink) {
                    isProcessingGuestLink = true;
                    console.log('[Auth State] Setting isProcessingGuestLink = true.');

                    if (user && !user.isAnonymous) {
                        console.log('[Auth State] Signing out existing non-anonymous user for guest flow...');
                        signOut(auth).then(() => {
                            console.log('[Auth State] Sign out complete. Proceeding with handleGuestAccess.');
                            // handleGuestAccess will call signInAnonymously, triggering another auth state change
                            handleGuestAccess(initialProjectId, initialGuestToken).finally(() => { // Use initial values
                                isProcessingGuestLink = false;
                                console.log('[Auth State] Reset isProcessingGuestLink = false (after signout flow).');
                            });
                        }).catch(err => {
                            console.error('[Auth State] Error signing out before guest flow:', err);
                            loadingSpinner.innerHTML = `<p class="text-red-400">Error preparing guest access. Please try again.</p>`;
                            isProcessingGuestLink = false;
                            console.log('[Auth State] Reset isProcessingGuestLink = false (on signout error).');
                        });
                    } else {
                        // User is null or already anonymous, proceed
                        console.log('[Auth State] User is null or anonymous. Proceeding directly with handleGuestAccess.');
                        handleGuestAccess(initialProjectId, initialGuestToken).finally(() => { // Use initial values
                            isProcessingGuestLink = false;
                            console.log('[Auth State] Reset isProcessingGuestLink = false (after direct guest flow).');
                        });
                    }
                } else {
                    console.log('[Auth State] Guest token found, but isProcessingGuestLink is true. Skipping handleGuestAccess call.');
                    // This block will run when signInAnonymously completes
                    if (user && user.isAnonymous) {
                         console.log('[Auth State] Processing guest, anonymous user confirmed. Calling loadProjectForUser.');
                         isGuest = true; // Make sure isGuest is set (handleGuestAccess might not have set it yet if it's still running)
                         loadProjectForUser(user);
                    }
                }
                return; // Stop further checks if guest token exists
            }

            // --- PRIORITY 2: Handle Regular Logged-In User (only if no guest token) ---
            else if (user && !user.isAnonymous) {
                console.log('[Auth State] Condition MET: Regular user (no guest token). Loading project.');
                isGuest = false; // Ensure flag is correct
                loadProjectForUser(user);
            }

            // --- PRIORITY 3: Handle Stray Anonymous User (no guest token) ---
            else if (user && user.isAnonymous && !initialGuestToken) {
                console.warn('[Auth State] Condition MET: Anonymous user (no guest token). Signing out and redirecting.');
                signOut(auth);
                window.location.href = 'index.html';
                return; // Exit
            }

            // --- PRIORITY 4: No User, No Guest Token (Redirect) ---
            else if (!user && !initialGuestToken) {
                console.log('[Auth State] Condition MET: No user and no guest token. Redirecting.');
                window.location.href = 'index.html';
            }

            // --- Fallback ---
            else {
                console.error(`[Auth State] Reached unexpected final else. User: ${user}, Token: ${initialGuestToken}`);
            }
        }); // --- End onAuthStateChanged ---


        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                 console.log('[Logout] Button clicked.');
                signOut(auth);
            });
        } else {
             console.warn('[Init] Logout button not found.');
        }


        // Notification Bell Logic
        const notificationBell = document.getElementById('notification-bell');
        const notificationPanel = document.getElementById('notification-panel');

        if(notificationBell && notificationPanel){
            notificationBell.addEventListener('click', () => {
                notificationPanel.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!notificationBell.contains(event.target) && !notificationPanel.contains(event.target)) {
                    notificationPanel.classList.add('hidden');
                }
            });
        } else {
             console.warn('[Init] Notification elements not found.');
        }

    </script>

    <!-- Annotation Modal -->
    <div id="annotation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
       <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 border border-slate-700/50">
           <div class="flex justify-between items-center mb-4">
               <h3 class="text-xl font-semibold text-white">Add a Comment</h3>
               <button id="modal-close-button" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
           </div>
           <form id="annotation-form">
               <textarea id="annotation-text" rows="4" class="w-full rounded-lg border-0 bg-white/5 py-2 px-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500" placeholder="Type your comment..."></textarea>
               <div class="mt-4 flex justify-end space-x-4">
                   <button type="button" id="modal-cancel-button" class="px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white font-semibold text-sm">Cancel</button>
                   <button type="submit" class="px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-semibold text-sm">Submit</button>
               </div>
           </form>
       </div>
    </div>
</body>
</html>